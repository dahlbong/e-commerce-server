# 🛒 e-커머스 상품 주문 서비스 기능 요구사항

## 개요

본 문서는 e-커머스 상품 주문 서비스의 요구사항을 정의합니다. 사용자는 상품을 조회하고, 선택한 상품을 주문하며, 충전된 잔액을 이용하여 결제할 수 있습니다. 또한 서비스는 판매량에 따른 인기 상품 추천 기능을 제공합니다.

---

# 📖 기능적 요구사항

## 1. 사용자 잔액 관리

### ✔️ 기능 설명
- 사용자가 결제에 사용할 금액을 사전에 충전하고, 현재 보유 잔액을 조회할 수 있어야 합니다.

### 🔹 1.1 잔액 조회
- 사용자 식별자를 입력받아 현재 잔액을 조회합니다.
- 존재하지 않는 사용자 식별자의 경우 오류를 반환합니다.

### 🔹 1.2. 잔액 충전
- 사용자 식별자와 충전할 금액을 입력받아 잔액을 충전합니다.
- 충전 성공 시, 갱신된 잔액 정보를 반환합니다. 
- 음수 금액 충전 요청은 오류를 반환합니다. 
- 최대 충전 한도를 초과하는 요청은 오류를 반환합니다.

---

## 2. 사용자 주문 조회

## ✔️ 기능 설명
- 사용자가 과거 주문 내역을 확인할 수 있어야 합니다.

### 🔹 2.1 주문 목록 조회
- 사용자 ID 기준 주문 목록을 최신순으로 조회
- 각 주문은 주문 ID, 상태, 주문일자, 총 금액 포함

### 🔹 2.2 주문 상품 정보 포함
- 주문 내 각 상품의 ID, 이름, 옵션, 수량, 가격, 썸네일 등 포함
- 주문 상태에 따른 처리 흐름(배송 중, 취소 등)은 추후 확장 가능

---


## 3. 상품 관리

### ✔️ 기능 설명
- 상품 정보를 실시간으로 확인하고, 상품 구매 시 재고를 관리합니다

### 🔹 3.1. 상품 조회
- 모든 상품의 정보(ID, 이름, 가격, 잔여수량)를 조회합니다. 
- 특정 상품 ID로 개별 상품 정보를 조회할 수 있습니다. 
- 조회 시점의 정확한 잔여수량 정보를 제공합니다.

### 🔹 3.2. 재고 조회
- 재고는 음이 아닌 정수입니다.
- 조회 시점의 재고 수량이 정확해야 하며, 캐시된 값이 아닌 실시간 값을 반영해야 합니다.
- 재고는 주문 요청에 따라 감소하며, 부족할 경우 주문은 거부되어야 합니다.

### 🔹 3.3. 상품 주문
- 상품 재고 검증이 완료되면 주문이 생성됩니다.

---

## 4. 쿠폰 발급 및 사용

### ✔️ 기능 설명
- 사용자가 선착순으로 쿠폰을 발급받고 주문 시 할인 혜택을 적용할 수 있어야 합니다.

### 🔹 4.1. 선착순 쿠폰 발급
- 선착순으로 할인 쿠폰을 발급합니다. 
- 쿠폰 발급 요청 시 사용자 식별자를 입력받습니다. 
- 쿠폰 수량이 소진된 경우 오류를 반환합니다. 
- 사용자당 동일 쿠폰 중복 발급을 방지합니다. 
- 쿠폰 발급 성공 시 쿠폰 정보(ID, 할인율/금액, 유효기간 등)를 반환합니다.

### 🔹 4.2. 보유 쿠폰 조회
- 사용자 식별자를 입력받아 해당 사용자가 보유한 모든 쿠폰 목록을 조회합니다. 
- 각 쿠폰의 상태(사용 가능, 사용 완료, 만료됨)를 표시합니다. 
- 쿠폰의 상세 정보(할인율/금액, 유효기간, 적용 조건 등)를 제공합니다.

---

## 5. 주문 및 결제 처리

### ✔️ 기능 설명
- 사용자가 여러 상품을 장바구니처럼 선택하여 주문하고, 보유 잔액과 쿠폰으로 결제할 수 있어야 합니다.

### 🔹 5.1. 주문
- 사용자 식별자, 주문할 상품 목록(상품 ID, 수량), 적용할 쿠폰 ID(선택적)를 입력받습니다. 
- 각 상품의 재고를 확인하고, 재고 부족 시 오류를 반환합니다. 
- 총 주문 금액을 계산하고, 적용 가능한 쿠폰이 있다면 할인을 적용합니다. 
- 사용자의 잔액을 확인하고, 잔액 부족 시 오류를 반환합니다. 
- 결제를 진행합니다.

### 🔹 5.2. 결제
- 결제 성공 시 사용자 잔액을 차감하고, 주문 정보를 저장합니다. 
- 결제 성공 시 상품의 재고를 감소시킵니다. 
- 결제 성공 시 사용된 쿠폰은 사용 완료 상태로 변경합니다. 
- 결제 성공 시 주문 정보를 외부 데이터 플랫폼에 전송합니다. 
- 주문 성공 시 주문 번호와 결제 금액, 남은 잔액 등의 정보를 반환합니다.
- 하나라도 실패할 경우 전체 작업은 롤백됩니다.

---

## 6. 인기 판매 상품 조회

### ✔️ 기능 설명
- 최근 주문 데이터를 바탕으로 인기 상품을 조회 합니다.

### 🔹 6.1. 인기 상품 조회 
- 기준 기간은 기본적으로 최근 n일(상수 관리)입니다.
- 각 상품의 판매 수량 및 매출을 집계합니다.
- 동률 처리 시 매출액 → 상품 등록일 순으로 우선순위를 적용합니다.
- 각 상품별 판매 수량과 함께 정보를 반환합니다.

---

## 7. 장바구니

### ✔️ 기능 설명
- 사용자가 상품을 장바구니에 담고, 수량을 변경하거나 삭제하며, 최종적으로 주문할 수 있도록 합니다.

### 🔹 7.1. 장바구니 상품 추가
- 상품 ID, 옵션(variant ID), 수량 입력
- 판매 중 & 재고 충분 시 추가 가능
- 기존에 담긴 상품이면 수량 증가, 아니면 새로 insert
- 재고 부족 또는 판매 중지 시 오류 반환

### 🔹 7.2. 장바구니 상품 삭제
- 개별 항목 삭제: 상품 ID + 옵션 ID 기준
- 전체 비우기 지원
- 존재하지 않는 항목 삭제 시 오류 메시지 반환

### 🔹 7.3. 장바구니 내 상품 수량 변경
- 변경 요청 수량을 기준으로 장바구니 내 수량을 수정
- 요청 수량이 재고보다 많으면 오류 반환
- 재고 확인 후 cart_items 테이블 update

### 🔹 7.4 장바구니 조회
- 사용자 ID 기준 장바구니 전체 항목을 반환
- 상품 이름, 이미지, 수량, 재고, 가격 등 포함
- 품절/삭제 상품도 상태 표시로 구분 가능

### 🔹 7.5 장바구니 상품 주문
- 장바구니 상품 목록을 기준으로 주문 생성
- 재고가 검증되면 주문이 생성됩니다.


---

## 8. 시스템 안정성 및 테스트 자동화

### ✔️ 기능 설명
- 모든 기능은 안정성과 테스트 자동화를 기반으로 동작해야 하며, 분산 환경에서도 일관성을 유지해야 합니다.

### 8.1. 🔹 상세 요구사항
- 잔액, 재고, 쿠폰, 주문 관련 상태 변경은 트랜잭션 또는 분산 락 등으로 보호
- 동시성 테스트로 안정성 검증 필수
- 단위/통합/성능 테스트를 포함한 테스트 자동화 구축
- 오류는 사용자 친화적 메시지 + HTTP 상태 코드로 응답
- 주요 이벤트에 대한 로깅 및 알림 시스템 통합

